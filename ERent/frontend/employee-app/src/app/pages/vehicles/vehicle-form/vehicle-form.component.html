<h2 mat-dialog-title class="vehicle-dialog-title">
  Add {{ (data.type | lowercase) | slice:0:-1 }}
</h2>

<div mat-dialog-content class="form-container">
  <form #vehicleForm="ngForm">

    <div class="form-row">
      <div>
        <label class="field-label">ID</label>
        <mat-form-field class="full-width" appearance="outline">
          <input matInput name="uniqueId"
                 [(ngModel)]="vehicle.uniqueId"
                 placeholder="ID"
                 required minlength="3" maxlength="50"
                 pattern="^[a-zA-Z0-9\-]+$" />
          <mat-error *ngIf="vehicleForm.submitted && !vehicle.uniqueId">
            ID is required
          </mat-error>
          <mat-error *ngIf="vehicleForm.submitted && vehicle.uniqueId?.length! < 3">
            ID must be at least 3 characters
          </mat-error>
        </mat-form-field>
      </div>

      <div>
        <label class="field-label">Manufacturer</label>
        <mat-form-field class="full-width" appearance="outline">
          <mat-select name="manufacturer"
                      [(ngModel)]="vehicle.manufacturer"
                      [compareWith]="compareManufacturer"
                      required
                      placeholder="Choose">
            <mat-option *ngFor="let m of manufacturers" [value]="m">
              {{ m.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="vehicleForm.submitted && !vehicle.manufacturer">
            Manufacturer is required
          </mat-error>
        </mat-form-field>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label class="field-label">Model</label>
        <mat-form-field class="full-width" appearance="outline">
          <input matInput name="model"
                 [(ngModel)]="vehicle.model"
                 placeholder="Model"
                 required minlength="2" maxlength="100" />
          <mat-error *ngIf="vehicleForm.submitted && !vehicle.model">
            Model is required
          </mat-error>
        </mat-form-field>
      </div>

      <div>
        <label class="field-label">Purchase price</label>
        <mat-form-field class="full-width" appearance="outline">
          <input matInput type="number" name="purchasePrice"
                 [(ngModel)]="vehicle.purchasePrice"
                 placeholder="Purchase price"
                 required min="1" />
          <mat-error *ngIf="vehicleForm.submitted && !vehicle.purchasePrice">
            Purchase price is required
          </mat-error>
          <mat-error *ngIf="vehicle.purchasePrice != null && vehicle.purchasePrice <= 0">
            Price must be greater than 0
          </mat-error>
        </mat-form-field>
      </div>
    </div>

    <ng-container *ngIf="data.type === 'cars'">
      <div class="form-row">
        <div>
          <label class="field-label">Purchase date</label>
          <mat-form-field class="full-width" appearance="outline">
            <input matInput [matDatepicker]="picker" name="purchaseDate"
                   [(ngModel)]="vehicle.purchaseDate"
                   required placeholder="Purchase date" />
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
          <mat-error *ngIf="vehicleForm.submitted && !vehicle.purchaseDate">
            Purchase date is required
          </mat-error>
        </div>

        <div>
          <label class="field-label">Image</label>
          <div class="image-preview" *ngIf="vehicle.imagePath && !selectedImage">
            <div class="image-preview" *ngIf="vehicle.imagePath && !selectedImage">
              <img [src]="vehiclesService.getImageUrl(vehicle.imagePath)"
                  alt="Vehicle image"
                  style="max-width: 200px; border-radius: 8px; margin-bottom: 8px;"/>
            </div>
          </div>
          <div class="image-preview" *ngIf="selectedImage">
            <img [src]="selectedImagePreview"
                 alt="New vehicle image"
                 style="max-width: 200px; border-radius: 8px; margin-bottom: 8px;"/>
          </div>
          <div class="image-dropzone"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               (drop)="onDrop($event)">
            <p *ngIf="!selectedImage">Drag & drop image here or click to select</p>
            <p *ngIf="selectedImage">Selected: {{ selectedImage.name }}</p>
            <input type="file"
                   class="file-input"
                   (change)="onFileSelected($event)"
                   accept="image/*" />
          </div>
        </div>
      </div>

      <label class="field-label">Description</label>
      <mat-form-field class="full-width" appearance="outline">
        <textarea matInput rows="3" name="description"
                  [(ngModel)]="vehicle.description"
                  placeholder="Description"
                  minlength="5" maxlength="255"></textarea>
      </mat-form-field>
    </ng-container>

    <ng-container *ngIf="data.type === 'bikes'">
      <div class="form-row">
        <div>
          <label class="field-label">Autonomy</label>
          <mat-form-field class="full-width" appearance="outline">
            <input matInput type="number" name="autonomy"
                   [(ngModel)]="vehicle.autonomy"
                   placeholder="Autonomy"
                   required min="1" />
            <mat-error *ngIf="vehicleForm.submitted && !vehicle.autonomy">
              Autonomy is required
            </mat-error>
          </mat-form-field>
        </div>

        <div>
          <label class="field-label">Image</label>
          <div class="image-preview" *ngIf="vehicle.imagePath && !selectedImage">
            <img [src]="vehiclesService.getImageUrl(vehicle.imagePath)"
                alt="Vehicle image"
                style="max-width: 200px; border-radius: 8px; margin-bottom: 8px;"/>
          </div>
          <div class="image-preview" *ngIf="selectedImage">
            <img [src]="selectedImagePreview"
                 alt="New vehicle image"
                 style="max-width: 200px; border-radius: 8px; margin-bottom: 8px;"/>
          </div>
          <div class="image-dropzone"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               (drop)="onDrop($event)">
            <p *ngIf="!selectedImage">Drag & drop image here or click to select</p>
            <p *ngIf="selectedImage">Selected: {{ selectedImage.name }}</p>
            <input type="file"
                   class="file-input"
                   (change)="onFileSelected($event)"
                   accept="image/*" />
          </div>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="data.type === 'scooters'">
      <div class="form-row">
        <div>
          <label class="field-label">Max speed</label>
          <mat-form-field class="full-width" appearance="outline">
            <input matInput type="number" name="maxSpeed"
                   [(ngModel)]="vehicle.maxSpeed"
                   placeholder="Max Speed"
                   required min="1" />
            <mat-error *ngIf="vehicleForm.submitted && !vehicle.maxSpeed">
              Max speed is required
            </mat-error>
          </mat-form-field>
        </div>

        <div>
          <label class="field-label">Image</label>
          <div class="image-preview" *ngIf="vehicle.imagePath && !selectedImage">
          <div class="image-preview" *ngIf="vehicle.imagePath && !selectedImage">
            <img [src]="vehiclesService.getImageUrl(vehicle.imagePath)"
                alt="Vehicle image"
                style="max-width: 200px; border-radius: 8px; margin-bottom: 8px;"/>
          </div>
          </div>
          <div class="image-preview" *ngIf="selectedImage">
            <img [src]="selectedImagePreview"
                 alt="New vehicle image"
                 style="max-width: 200px; border-radius: 8px; margin-bottom: 8px;"/>
          </div>
          <div class="image-dropzone"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               (drop)="onDrop($event)">
            <p *ngIf="!selectedImage">Drag & drop image here or click to select</p>
            <p *ngIf="selectedImage">Selected: {{ selectedImage.name }}</p>
            <input type="file"
                   class="file-input"
                   (change)="onFileSelected($event)"
                   accept="image/*" />
          </div>
        </div>
      </div>
    </ng-container>
  </form>
</div>

<div mat-dialog-actions class="dialog-actions">
  <button mat-stroked-button color="warn" (click)="cancel()">Cancel</button>
  <button mat-raised-button color="primary" 
          [disabled]="!vehicleForm.valid" 
          (click)="save()">
    Save
  </button>
</div>